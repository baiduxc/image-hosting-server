version: '3.8'

services:
  # 使用 SQLite 的图床服务
  image-hosting-sqlite:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: image-hosting-sqlite
    ports:
      - "3001:3001"
    environment:
      # 数据库配置
      - DB_TYPE=sqlite
      - SQLITE_PATH=/app/data/database.sqlite
      
      # JWT 配置（请修改为强密码）
      - JWT_SECRET=your-strong-secret-key-here-please-change-it
      
      # 服务器配置
      - PORT=3001
      - NODE_ENV=production
    volumes:
      # 持久化数据
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./backups:/app/backups
      - ./migrations:/app/migrations
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # 使用 PostgreSQL 的图床服务（可选）
  image-hosting-postgres:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: image-hosting-postgres
    ports:
      - "3002:3001"
    environment:
      # 数据库配置
      - DB_TYPE=postgres
      - DATABASE_URL=postgresql://imagedb_user:imagedb_password@postgres:5432/imagedb
      - DB_SSL_MODE=false
      
      # JWT 配置
      - JWT_SECRET=your-strong-secret-key-here-please-change-it
      
      # 服务器配置
      - PORT=3001
      - NODE_ENV=production
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - postgres

  # PostgreSQL 数据库（可选）
  postgres:
    image: postgres:16-alpine
    container_name: image-hosting-db
    environment:
      - POSTGRES_DB=imagedb
      - POSTGRES_USER=imagedb_user
      - POSTGRES_PASSWORD=imagedb_password
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imagedb_user -d imagedb"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    profiles:
      - postgres

volumes:
  postgres_data:
    driver: local

# 使用说明：
# 
# 1. 使用 SQLite（默认，推荐个人使用）：
#    docker-compose up -d image-hosting-sqlite
#
# 2. 使用 PostgreSQL（多用户场景）：
#    docker-compose --profile postgres up -d
#
# 3. 停止服务：
#    docker-compose down
#
# 4. 查看日志：
#    docker-compose logs -f
#
# 5. 重新构建：
#    docker-compose build --no-cache

